<!DOCTYPE html>
<html lang=" en" class="antialiased"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Authenticate to Graph in Azure Functions with Managed Identites (Part 1) | Powers Hell</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Authenticate to Graph in Azure Functions with Managed Identites (Part 1)" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When creating Azure Functions, there has always been a way to create and use ‚Äúmanaged identities‚Äù to securely and simply access resources within the resource group that the function app resides. With a little bit of PowerShell and a basic understanding of how API permissions are programmatically applied, we can use the managed identity to access Graph without needing to store credentials anywhere! Secure AND cool, right?" />
<meta property="og:description" content="When creating Azure Functions, there has always been a way to create and use ‚Äúmanaged identities‚Äù to securely and simply access resources within the resource group that the function app resides. With a little bit of PowerShell and a basic understanding of how API permissions are programmatically applied, we can use the managed identity to access Graph without needing to store credentials anywhere! Secure AND cool, right?" />
<link rel="canonical" href="https://powers-hell.com/2022/09/12/authenticate-to-graph-in-azure-functions-with-managed-identites/" />
<meta property="og:url" content="https://powers-hell.com/2022/09/12/authenticate-to-graph-in-azure-functions-with-managed-identites/" />
<meta property="og:site_name" content="Powers Hell" />
<meta property="og:image" content="https://powers-hell.com/assets/images/2022/09/setRoles.gif" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-12T02:32:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://powers-hell.com/assets/images/2022/09/setRoles.gif" />
<meta property="twitter:title" content="Authenticate to Graph in Azure Functions with Managed Identites (Part 1)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ben"},"dateModified":"2022-09-12T02:32:00+00:00","datePublished":"2022-09-12T02:32:00+00:00","description":"When creating Azure Functions, there has always been a way to create and use ‚Äúmanaged identities‚Äù to securely and simply access resources within the resource group that the function app resides. With a little bit of PowerShell and a basic understanding of how API permissions are programmatically applied, we can use the managed identity to access Graph without needing to store credentials anywhere! Secure AND cool, right?","headline":"Authenticate to Graph in Azure Functions with Managed Identites (Part 1)","image":"https://powers-hell.com/assets/images/2022/09/setRoles.gif","mainEntityOfPage":{"@type":"WebPage","@id":"https://powers-hell.com/2022/09/12/authenticate-to-graph-in-azure-functions-with-managed-identites/"},"url":"https://powers-hell.com/2022/09/12/authenticate-to-graph-in-azure-functions-with-managed-identites/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/prism-dracula.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>
    <script data-ad-client="ca-pub-3537558222002149" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SGKQTF5F0T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SGKQTF5F0T');
</script>
    <style type="text/css">
        :root {
            --dynamic-page-color: orange;
        }
    </style>
</head><body><div class="page-container">
    <div class="">
        <nav x-data="{ open: false }" class="nav sticky drac-bg-blackBlack">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 link-hover">
                            <h2 class="drac-heading drac-heading-xl"><a href="/">Powers Hell</a></h2>
                        </div>
                        <div class="hidden md:block flex-shrink-0">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <div id="tagalign" class="drac-text drac-text-cyan drac-text-right drac-line-height">
                                    great/power/is/great/fun >
                                    <div class="cursor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block flex-shrink-0">
                        <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                    </div>
                    <div class="mr-2 flex md:hidden">
                        <!-- Mobile menu button -->
                        <button type="button"
                            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm items-center justify-center p-2"
                            aria-controls="mobile-menu" aria-expanded="false" @click="open = !open" ara-expanded="false"
                            x-bind-aria-expanded="open.toString()">
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'hidden':open, 'block': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>

                            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'block':open, 'hidden': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="drac-bg-black md:hidden" x-show.transition="open">
                <div class="px-2 py-3 space-y-1 sm:px-3 items-center">
                    <div id="tagalign" class="ml-3 drac-text drac-text-cyan drac-line-height">
                        great/power/is/great/fun >
                        <div class="cursor"></div>
                    </div>
                    <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                </div>
            </div>
        </nav>
      <div class="drac-bg-blackBlack pb-6 md:pb-24 lg:pb-28 xl:pb-8">
        <header class="py-10"><div class="main-overlay max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <h1
        class="drac-heading drac-heading-2xl drac-text-center drac-text-orange">
        
        Authenticate to Graph in Azure Functions with Managed Identites (Part 1)
        
    </h1>
    
</div></header>
      </div>
      <div>
        <svg class="wave" viewBox="0 0 1792 335" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path d="M 0 50 C 259 50 259 209 518 209 L 518 209 L 518 0 L 0 0 Z" stroke-width="0"></path>
        <path d="M 517 209 C 800 209 800 96 1083 96 L 1083 96 L 1083 0 L 517 0 Z" stroke-width="0"></path>
        <path d="M 1082 96 C 1437 96 1437 189 1792 189 L 1792 189 L 1792 0 L 1082 0 Z" stroke-width="0"></path>
        </svg>
      </div><main class="-mt-4 md:-mt-64 lg:-mt-72 xl:-mt-80 2xl:-mt-96 4xl:-mt-112">
    <div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
        <div class=" break-normal md:break-word drac-bg-black rounded-lg shadow-2xl px-5 py-6 sm:px-6">
            <article class="markdown-body drac-text drac-line-height line-numbers">

                <p class="post-date drac-text drac-text-xs"><font class="drac-text-black-secondary">Published:</font>
                    <font class="drac-text-orange"> 12 Sep 2022</font>
                    <br/>
                    <font class="drac-text-black-secondary">File under:</font>
<font class="drac-text drac-text-xs">
    <a href="/category/authentication/" class="related">Authentication</a>, <a href="/category/azure-functions/" class="related">Azure Functions</a>, <a href="/category/graph/" class="related">Graph</a>,  <a href="/category/powershell/" class="related">PowerShell</a></font></p>
                
                <span>
          <a href="/assets/images/2022/09/setRoles.gif" title="Hero Image"><img src="/assets/images/2022/09/setRoles.gif" alt="Authenticate to Graph in Azure Functions with Managed Identites (Part 1)"></a>
        </span>  <p>When creating Azure Functions, there has always been a way to create and use ‚Äúmanaged identities‚Äù to securely and simply access resources within the resource group that the function app resides.</p>

<p>With a little bit of PowerShell and a basic understanding of how API permissions are programmatically applied, we can use the managed identity to access Graph without needing to store credentials anywhere! Secure AND cool, right?</p>

<!--more-->

<p>In part 1 of a 2 part series, first, let‚Äôs spend some time understanding how to assign the Graph permissions to a managed identity.</p>

<p>I was lucky enough to be accepted to speak at the recent <a href="https://psconf.eu/">PSConf.EU</a> 2022 conference in Austria, where I got to hang out with 350 of the most PowerShell obsessed people on the planet. It‚Äôs always been a highlight of my year to attend PSConf and this year was no different.</p>

<p>While there I presented two talks - one on how <a href="https://www.youtube.com/watch?v=PkqLLW7DCMM">PowerShell &amp; ‚ÄúCode Reuse‚Äù can optimise and elevate your career</a>, and the other - which is of relevance to this article, was how to leverage PowerShell &amp; Azure Functions to build better dynamic groups in AAD.</p>

<div class="video-container">
<iframe width="560" height="315" src="https://www.youtube.com/embed/n3jjq68leKs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media;" allowfullscreen=""></iframe>
</div>

<p>One of the cool things that I ran into while writing the demos for this session was that I could leverage the <strong>Managed Identity</strong> authentication that is ‚Äúautomagically‚Äù configured for me to handle the authentication / authorization duties that are required for any calls to Graph.</p>

<h2 id="so-what-is-a-managed-identity">So, what is a managed identity?</h2>

<p>The simplest way to understand what a managed identity is is to think of it as a service account / service principal, but one that you NEVER need to know what the credentials are and will exist in your Azure tenant as long as the resource that generated the identity exists. For a deeper understanding of this - <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-managed-identities-work-vm">read the official documentation!</a></p>

<p>Makes sense? Let‚Äôs make one then!</p>

<h2 id="create-the-function-app--managed-identity">Create the Function app &amp; managed identity</h2>

<p>I‚Äôve already discussed fairly at length how to create an Azure Function, so I wont discuss it further, but for now, if you haven‚Äôt created a function app to play with, go do that first and then come back - I‚Äôll wait right here..</p>

<p>Back? Cool, let‚Äôs continue!</p>

<p>Hop into the Azure Function app and select the <strong>Identity</strong> link in the side menu.</p>

<p><a href="/assets/images/2022/09/managed-identities.png" title="Managed Identities"><img src="/assets/images/2022/09/managed-identities.png" alt="Managed Identities" /></a></p>

<p>We are just going to focus on creating <strong>system assigned</strong> identities today, so just switch the feature <strong>ON</strong>, save the changes and accept the prompt that appears.</p>

<p>After a few minutes we should have the identity created and available for us!</p>

<p>Make a note of the name of the Function app name and the Managed Identity Id - we will need those for later.</p>

<p><a href="/assets/images/2022/09/managed-identities2.png" title="Managed Identities"><img src="/assets/images/2022/09/managed-identities2.png" alt="Managed Identities" /></a></p>

<h2 id="apply-the-graph-api-roles-to-the-managed-identity">Apply the Graph API roles to the managed identity</h2>

<p>Let‚Äôs go and look at the managed identity. First head over to AAD &gt; Enterprise Applications. Change the <strong>Application type</strong> filter to <strong>Managed Identities</strong> and search for the identity via the name OR the Id. Once you‚Äôve found the identity, open it up and head to <strong>Permissions</strong>.</p>

<p>Here we should see the first wrinkle - currently there is no way to manage assigned API permissions of an enterprise application - so if we can‚Äôt do it from the UI, then let‚Äôs open up PowerShell to solve the problem!</p>

<p>This is where I had hoped I could stop my research into this - surely a problem as basic as this has already been solved?! Well, as it turns out, the answer to that is‚Ä¶ ‚Äúkind of‚Äù.</p>

<p>I found dozens of blog posts (<a href="https://baswijdenes.com/how-to-use-managed-identities-with-microsoft-graph-api/">here‚Äôs one that showed real promise‚Ä¶</a>) and solutions that have been written that leverage Microsoft‚Äôs old Azure PowerShell modules, but with the release of the new Az modules, none of these solutions work and even more frustatingly, the solutions written for the old modules do NOT migrate across - which leaves us stuck.</p>

<p>Thankfully, once I realized what was required - It became easier to focus my search and I <a href="https://gotoguy.blog/2022/03/15/add-graph-application-permissions-to-managed-identity-using-graph-explorer/">found into a blog post</a> written by <a href="https://twitter.com/JanVidarElven">Jan Vidar Elven</a> that shows the native Graph calls required to interact with the managed identity AND how to manage the API permissions of the enterprise application!</p>

<p>So let‚Äôs use what Jan has figured out to write a solution to add Graph roles to our identity!</p>

<h4 id="authentication">Authentication</h4>

<p>First let‚Äôs authenticate - to make this easy, let‚Äôs just use the Az.Accounts module so that we can have the correct scope and permissions to do the work we need to do.</p>

<pre><code class="language-PowerShell">Connect-AzAccount
$token = (Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com").Token
</code></pre>

<p>Nice and simple - we just use our authenticated identity to Azure to generate an auth token scoped to Graph - which will let us make the Graph calls we will need to make.</p>

<h4 id="grab-the-identity-objects">Grab the identity objects</h4>

<p>Next, let‚Äôs get all of the identities we need..</p>

<pre><code class="language-PowerShell">$baseUri = 'https://graph.microsoft.com/v1.0/servicePrincipals'
$graphAppId = '00000003-0000-0000-c000-000000000000'
$spSearchFiler = '"displayName:{0}" OR "appId:{1}"' -f $ApplicationName, $graphAppId
$msiParams = @{
    Method  = 'Get'
    Uri     = '{0}?$search={1}' -f $baseUri, $spSearchFiler
    Headers = @{Authorization = "Bearer $Token"; ConsistencyLevel = "eventual" }
}
$spList = (Invoke-RestMethod @msiParams).Value
$msiId = ($spList | Where-Object { $_.displayName -eq $applicationName }).Id
$graphId = ($spList | Where-Object { $_.appId -eq $graphAppId }).Id
</code></pre>

<p>This here is kind of cool - first we are grabbing a list of all service principal identities in our tenant - nothing super complicated. Then we cherry pick out the Managed Identity that we want as well as the unique Graph identity that exists in our tenant!</p>

<h4 id="get-the-role-objects-from-graph">Get the role objects from Graph</h4>

<p>Now that we have the identities we need, let‚Äôs prepare the roles / permissions. For this example, lets use a few common API permissions that people need..</p>

<pre><code class="language-PowerShell">$roles = @(
    "DeviceManagementApps.ReadWrite.All"
    "DeviceManagementConfiguration.Read.All"
    "DeviceManagementManagedDevices.Read.All"
    "GroupMember.Read.All"
)
@graphRoleParams = @{
    Method  = 'Get'
    Uri     = "$baseUri/$($GraphId)/appRoles"
    Headers = @{Authorization = "Bearer $Token"; ConsistencyLevel = "eventual" }
}
$graphRoles = (Invoke-RestMethod @graphRoleParams).Value | 
        Where-Object {$_.value -in $GraphApiRole -and $_.allowedMemberTypes -Contains "Application"} |
        Select-Object allowedMemberTypes, id, value
</code></pre>
<p>If we expand out the results of <code class="language-plaintext highlighter-rouge">$graphRoles</code> we can see all of the data we get back from the Graph application for each role - specifically all we really need is the Id of the role.</p>

<p><a href="/assets/images/2022/09/approles.png" title="List of the app roles!"><img src="/assets/images/2022/09/approles.png" alt="List of the app roles!" /></a></p>

<h4 id="apply-the-roles-to-the-managed-identity">Apply the roles to the Managed Identity</h4>

<p>Finally once we have the role info, we need to build out a request to attach each role to the Managed Identity.</p>

<pre><code class="language-PowerShell">$baseUri = 'https://graph.microsoft.com/v1.0/servicePrincipals'
foreach ($role in $graphRoles) {
    $postBody = @{
        "principalId" = $msiId
        "resourceId"  = $graphId
        "appRoleId"   = $role.Id
    }
    $restParams = @{
        Method      = "Post"
        Uri         = "$baseUri/$($graphId/appRoleAssignedTo"
        Body        = $postBody | ConvertTo-Json
        Headers     = @{Authorization = "Bearer $token" }
        ContentType = 'Application/Json'
    }
    $roleRequest = Invoke-RestMethod @restParams
    $roleRequest
}
</code></pre>

<p>Now if we go back to the Managed Identity in our AAD portal, we should see the permissions shown!</p>

<p><a href="/assets/images/2022/09/assignedRoles.png" title="Assigned Roles in Portal"><img src="/assets/images/2022/09/assignedRoles.png" alt="Assigned Roles in Portal" /></a></p>

<p>We can also validate this using PowerShell‚Ä¶</p>

<pre><code class="language-PowerShell">$header = @{Authorization = "Bearer $token" }
$roles = irm -Method get -Uri "$baseUri/$msiId/appRoleAssignments" -Headers $header
</code></pre>

<h4 id="put-it-all-together">Put it all together!</h4>

<p>Now that we know the basic code to get all of this working, with a little bit of error handling, we should be able to build out a neat little function to help us with this work in the future!</p>

<pre><code class="language-PowerShell">function Add-GraphApiRoleToMSI {
    [cmdletbinding()]
    param (
        [parameter(Mandatory = $true)]
        [string]$ApplicationName,

        [parameter(Mandatory = $true)]
        [string[]]$GraphApiRole,

        [parameter(mandatory = $true)]
        [string]$Token
    )

    $baseUri = 'https://graph.microsoft.com/v1.0/servicePrincipals'
    $graphAppId = '00000003-0000-0000-c000-000000000000'
    $spSearchFiler = '"displayName:{0}" OR "appId:{1}"' -f $ApplicationName, $graphAppId

    try {
        $msiParams = @{
            Method  = 'Get'
            Uri     = '{0}?$search={1}' -f $baseUri, $spSearchFiler
            Headers = @{Authorization = "Bearer $Token"; ConsistencyLevel = "eventual" }
        }
        $spList = (Invoke-RestMethod @msiParams).Value
        $msiId = ($spList | Where-Object { $_.displayName -eq $applicationName }).Id
        $graphId = ($spList | Where-Object { $_.appId -eq $graphAppId }).Id
        $msiItem = Invoke-RestMethod @msiParams -Uri "$($baseUri)/$($msiId)?`$expand=appRoleAssignments"

        $graphRoles = (Invoke-RestMethod @msiParams -Uri "$baseUri/$($graphId)/appRoles").Value | 
        Where-Object {$_.value -in $GraphApiRole -and $_.allowedMemberTypes -Contains "Application"} |
        Select-Object allowedMemberTypes, id, value
        foreach ($roleItem in $graphRoles) {
            if ($roleItem.id -notIn $msiItem.appRoleAssignments.appRoleId) {
                Write-Host "Adding role ($($roleItem.value)) to identity: $($applicationName).." -ForegroundColor Green
                $postBody = @{
                    "principalId" = $msiId
                    "resourceId"  = $graphId
                    "appRoleId"   = $roleItem.id
                }
                $postParams = @{
                    Method      = 'Post'
                    Uri         = "$baseUri/$graphId/appRoleAssignedTo"
                    Body        = $postBody | ConvertTo-Json
                    Headers     = $msiParams.Headers
                    ContentType = 'Application/Json'
                }
                $result = Invoke-RestMethod @postParams
                if ( $PSBoundParameters['Verbose'] -or $VerbosePreference -eq 'Continue' ) {
                    $result
                 }
            }
            else {
                Write-Host "role ($($roleItem.value)) already found in $($applicationName).." -ForegroundColor Yellow
            }
        }
        
    }
    catch {
        Write-Warning $_.Exception.Message
    }
}
</code></pre>

<p>Now whenever you need to add Graph API permissions to a Managed Identity, you just call this function with an auth token, the name of the function app / Managed Identity and a list of permissions you want to apply!</p>

<p>As always, the code for todays post is available on <a href="https://github.com/tabs-not-spaces/CodeDump/tree/master/GraphApiToMSI">GitHub</a>. Stay tuned for the next article where I will show you how to use what we have learned here to leverage Managed Identities to create graph calls in function apps!</p>

<p><a href="https://twitter.com/powers_hell">‚Äî Ben</a></p>

            </article>
        </div>
    </div><div class="main-overlay max-w-5xl mx-auto pb-4 overflow-hidden">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3537558222002149" crossorigin="anonymous"></script>
    <!-- horizontal-ad-unit -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3537558222002149" data-ad-slot="4617860412" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-orange" />
    </div>
    <h2 class="drac-heading drac-heading-xl drac-text-orange">Related Posts</h2>
    <ul class="related">
        
        <li><a href="/2021/07/18/authenticating-to-microsoft-graph-with-powershell-(2021)/"><span class="drac-text-orange">&raquo;</span> Authenticating to Microsoft Graph with PowerShell - (2021)</a></li>
        
        <li><a href="/2021/12/27/manage-intune-trusted-certificate-profile-expiration-with-powershell/"><span class="drac-text-orange">&raquo;</span> Manage Intune Trusted Certificate Profile Expiration with PowerShell & Microsoft Graph</a></li>
        
        <li><a href="/2021/06/16/create-advanced-dynamic-groups-with-powershell-azure-functions/"><span class="drac-text-orange">&raquo;</span> Create advanced dynamic groups with PowerShell & Azure Functions</a></li>
        
        <li><a href="/2021/07/04/create-assign-filters-with-powershell-graph/"><span class="drac-text-orange">&raquo;</span> Create & assign filters with PowerShell & Graph</a></li>
        
        <li><a href="/2021/01/19/publishing-powershell-scripts-to-intune-with-graph/"><span class="drac-text-orange">&raquo;</span> Publishing PowerShell scripts to Intune with Graph</a></li>
        
    </ul>
</div>
<div class="pagination main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center utterances">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-orange" />
    </div>
    <script src="https://utteranc.es/client.js" repo="tabs-not-spaces/powers-hell-blog" issue-term="title" theme="github-dark" crossorigin="anonymous" async>
    </script>
</div></main>
  </div><script src="/assets/js/app.js"></script>
<script src="/assets/js/prism.js"></script>
<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">
</div>
<div>
    <svg class="wave" viewBox="0 0 1792 95.1" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path
            d="M1792,95.1c0-27,0-54,0-80.9c-40.7-5.1-101.2-11-174.5-12.3c-185.3-3.3-260.9,26.8-411.8,42.6
c-297.5,31.2-285-56-548.1-16.1C536.2,46.6,452.1,77.6,335.5,43C294,30.7,251,10.8,179.2,3C104.9-5,42.2,4.5,0,14.1v80.9H1792z" />
    </svg>
    <footer class="main-overlay drac-bg-blackBlack flex flex-wrap items-center justify-between p-3 m-auto">
        <div class="container mx-auto flex flex-col flex-wrap items-center justify-between">
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p class="drac-text-purple-cyan">
                        Powers Hell ¬© 2022
                    </p>
                    <p class="footer-links drac-text-xs drac-text-yellow">
                        <a href ="https://github.com/tabs-not-spaces/powers-hell-blog/commit/34beed26bb51e4674e5102809540203c3d824adc" target="_blank">
                            34beed2
                        </a>
                    </p>
                </span>
            </div>
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p>
                        made by
                        <a href="https://twitter.com/powers_hell" target="_blank" class="drac-text-yellow">
                            Ben
                        </a>
                        with
                        <a href="https://github.com/tabs-not-spaces" target="_blank"
                            class="drac-text-yellow-pink">
                            code, coffee & beer
                        </a>
                        üçª
                    </p>
                </span>
            </div>
        </div>
    </footer>
</div></body>

</html>