<!DOCTYPE html>
<html lang=" en" class="antialiased"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Monitor changes to Intune using Azure Functions, GraphAPI &#038; PowerShell | Powers Hell</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Monitor changes to Intune using Azure Functions, GraphAPI &#038; PowerShell" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In my last post, I showed you how to move a very common task – authenticating into the GraphAPI, up into an Azure Function App" />
<meta property="og:description" content="In my last post, I showed you how to move a very common task – authenticating into the GraphAPI, up into an Azure Function App" />
<link rel="canonical" href="https://powers-hell.com/2018/05/17/monitor-changes-to-intune-using-azure-functions-graphapi-powershell/" />
<meta property="og:url" content="https://powers-hell.com/2018/05/17/monitor-changes-to-intune-using-azure-functions-graphapi-powershell/" />
<meta property="og:site_name" content="Powers Hell" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-17T01:14:46+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Monitor changes to Intune using Azure Functions, GraphAPI &#038; PowerShell" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ben"},"dateModified":"2018-05-17T01:14:46+00:00","datePublished":"2018-05-17T01:14:46+00:00","description":"In my last post, I showed you how to move a very common task – authenticating into the GraphAPI, up into an Azure Function App","headline":"Monitor changes to Intune using Azure Functions, GraphAPI &#038; PowerShell","mainEntityOfPage":{"@type":"WebPage","@id":"https://powers-hell.com/2018/05/17/monitor-changes-to-intune-using-azure-functions-graphapi-powershell/"},"url":"https://powers-hell.com/2018/05/17/monitor-changes-to-intune-using-azure-functions-graphapi-powershell/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/prism-dracula.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>
    <script data-ad-client="ca-pub-3537558222002149" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SGKQTF5F0T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SGKQTF5F0T');
</script>
    <style type="text/css">
        :root {
            --dynamic-page-color: cyan;
        }
    </style>
</head><body><div class="page-container">
    <div class="">
        <nav x-data="{ open: false }" class="nav sticky drac-bg-blackBlack">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 link-hover">
                            <h2 class="drac-heading drac-heading-xl"><a href="/">Powers Hell</a></h2>
                        </div>
                        <div class="hidden md:block flex-shrink-0">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <div id="tagalign" class="drac-text drac-text-cyan drac-text-right drac-line-height">
                                    great/power/is/great/fun >
                                    <div class="cursor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block flex-shrink-0">
                        <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                    </div>
                    <div class="mr-2 flex md:hidden">
                        <!-- Mobile menu button -->
                        <button type="button"
                            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm items-center justify-center p-2"
                            aria-controls="mobile-menu" aria-expanded="false" @click="open = !open" ara-expanded="false"
                            x-bind-aria-expanded="open.toString()">
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'hidden':open, 'block': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>

                            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'block':open, 'hidden': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="drac-bg-black md:hidden" x-show.transition="open">
                <div class="px-2 py-3 space-y-1 sm:px-3 items-center">
                    <div id="tagalign" class="ml-3 drac-text drac-text-cyan drac-line-height">
                        great/power/is/great/fun >
                        <div class="cursor"></div>
                    </div>
                    <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                </div>
            </div>
        </nav>
      <div class="drac-bg-blackBlack pb-6 md:pb-24 lg:pb-28 xl:pb-8">
        <header class="py-10"><div class="main-overlay max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <h1
        class="drac-heading drac-heading-2xl drac-text-center drac-text-cyan">
        
        Monitor changes to Intune using Azure Functions, GraphAPI &#038; PowerShell
        
    </h1>
    
</div></header>
      </div>
      <div>
        <svg class="wave" viewBox="0 0 1792 335" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path d="M 0 50 C 259 50 259 209 518 209 L 518 209 L 518 0 L 0 0 Z" stroke-width="0"></path>
        <path d="M 517 209 C 800 209 800 96 1083 96 L 1083 96 L 1083 0 L 517 0 Z" stroke-width="0"></path>
        <path d="M 1082 96 C 1437 96 1437 189 1792 189 L 1792 189 L 1792 0 L 1082 0 Z" stroke-width="0"></path>
        </svg>
      </div><main class="-mt-4 md:-mt-64 lg:-mt-72 xl:-mt-80 2xl:-mt-96 4xl:-mt-112">
    <div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
        <div class=" break-normal md:break-word drac-bg-black rounded-lg shadow-2xl px-5 py-6 sm:px-6">
            <article class="markdown-body drac-text drac-line-height line-numbers">

                <p class="post-date drac-text drac-text-xs"><font class="drac-text-black-secondary">Published:</font>
                    <font class="drac-text-cyan"> 17 May 2018</font>
                    <br/>
                    <font class="drac-text-black-secondary">File under:</font>
<font class="drac-text drac-text-xs">
    <a href="/category/intune/" class="related">Intune</a>  <a href="/category/powershell/" class="related">PowerShell</a></font></p>
                 <p><a href="http://powers-hell.com/working-with-graphapi-powerbi-the-easy-way/" rel="noopener" target="_blank">In my last post</a>, I showed you how to move a very common task - authenticating into the GraphAPI, up into an Azure Function App.</p>

<p>Now that our authentication function has been turned into a REST Endpoint, we can stop focusing on <em>how</em> we get authenticated and start doing some really interesting stuff inside the environment. Case in point, myself and a colleague <a href="https://twitter.com/onpremcloudguy" rel="noopener" target="_blank">@OnPremCloudGuy</a> were wondering if we could create a solution to monitor the Intune configuration of a tenant for any changes that might get made without our approval. After a bit of digging around the GraphAPI documentation, and a few beers later, we had a very rough proof of concept to show that, indeed you can indeed report on changes in Intune!</p>

<p>The basic requirements of the solution involve 3 things:</p>

<ul>
  <li>A way to capture the existing configuration</li>
  <li>Somewhere to store that configuration</li>
  <li>And finally, a way to compare that configuration against the current Intune configuration</li>
</ul>

<p>We can achieve all three of these requirements with a single Azure Function App, so let’s jump right in and configure everything.</p>

<p>First, let’s create the Function App - give it a cool name, stick it in a resource group, and make note of the storage account used (new or existing doesn’t matter - we just need to know where everything is stored).</p>

<p><a href="https://i2.wp.com/i.imgur.com/n0hvpGt.png?w=1170&#038;ssl=1" title="Function App"><img src="https://i2.wp.com/i.imgur.com/n0hvpGt.png?w=1170&#038;ssl=1" alt="Function App" /></a></p>

<p>Once your new Function App is created, we will now set up a container to store the configuration snapshots.</p>

<p>Remember the storage account name? Let’s go into the storage accounts blade and select that account, and head into the containers blade.</p>

<p><a href="https://i2.wp.com/i.imgur.com/chCbFWu.png?w=1170&#038;ssl=1" title="Containers"><img src="https://i2.wp.com/i.imgur.com/chCbFWu.png?w=1170&#038;ssl=1" alt="Containers" /></a></p>

<p>You won’t see much here - just a single container housing your Function App. Let’s create a new container - I’ll call mine <strong>intunesnapshots</strong>. Keep the public access level at private.</p>

<p><a href="https://i0.wp.com/i.imgur.com/k4N1GYm.png?w=1170&#038;ssl=1" title="New containers"><img src="https://i0.wp.com/i.imgur.com/k4N1GYm.png?w=1170&#038;ssl=1" alt="New containers" /></a></p>

<p>Go into the properties of your freshly made container and make a note of the URL - you’ll need this later.</p>

<p>While we are in the storage account, lets also create a <strong>Shared Access Signature</strong> so that we can access the snapshots without too much effort - there are better ways to do this and if I wasn’t specifically using PowerShell as the language of choice, I’d go into this, but for now, lets just create SAS codes and move on to the cool stuff. Set the expiry time to a few days from now (or years, it’s your tenant, just <strong>be aware of the security implications</strong>), generate the SAS codes and again, store it for later.</p>

<p><a href="https://i0.wp.com/i.imgur.com/ggkJE4D.png?w=1170&#038;ssl=1" title="SASSSSSSY"><img src="https://i0.wp.com/i.imgur.com/ggkJE4D.png?w=1170&#038;ssl=1" alt="SASSSSSSY" /></a></p>

<p>Alright - your storage is set up, access &amp; security is set up to it, now let’s set up the functions. Head over to the Function App blade and add a new function to your newly created Function App. Let’s start with the snapshot creation endpoint.</p>

<p>As always (or until PowerShell moves out of the experimental phase), set <strong>Experimental Language Support</strong> to <strong>Enabled</strong>, choose <strong>PowerShell</strong> as your language of choice, and create a <strong>HTTP trigger</strong>.</p>

<p><a href="https://i2.wp.com/i.imgur.com/c96Tqph.png?w=1170&#038;ssl=1" title="Snapshot function"><img src="https://i2.wp.com/i.imgur.com/c96Tqph.png?w=1170&#038;ssl=1" alt="Snapshot function" /></a></p>

<p>As you will come to learn, I am a big fan of moving any user customizable settings/script configuration out of the main code block and into an appConfig.json file. It’s a handy way for the end user to be able to modify what the script does without being overwhelmed by a wall of code (and it makes demoing code that might have sensitive data all that easier!), so like in the last post, we are going to add a new file to the function. Your file structure should end up looking like this:</p>

<p><a href="https://i1.wp.com/i.imgur.com/p2pxuy3.png?w=1170&#038;ssl=1" title="appconfig.json"><img src="https://i1.wp.com/i.imgur.com/p2pxuy3.png?w=1170&#038;ssl=1" alt="appconfig.json" /></a></p>

<p>We aren’t going to put much into this config file right now - we just want to move the URL of the GraphAPI Connector that we made in the last post outside of the code so that if we ever want to change it, we know where to do so! The layout of your config should look as follows:</p>

<pre><code class="language-PowerShell">{
    "BasicConfig":
        {
            "graphConnectorURI" : "https://graphconnectorPOC.azurewebsites.net/api/GraphConnector?code=SuperSecretCode"
        }
}
</code></pre>

<p>Now we need to add some extra outputs into our function, so head over to the <strong>Integrate</strong> section, hit <strong>New Output</strong> and select <strong>Azure Blob Storage</strong></p>

<p><a href="https://i0.wp.com/i.imgur.com/CsFb0Oc.png?w=1170&#038;ssl=1" title="Azure blob storage"><img src="https://i0.wp.com/i.imgur.com/CsFb0Oc.png?w=1170&#038;ssl=1" alt="Azure blob storage" /></a></p>

<p>Set your storage account connection to AzureWebJobsStorage and update your path as shown in the screenshot below (anything in curly braces is a variable placeholder that gets its value from user input - very cool, very handy!).</p>

<p><a href="https://i1.wp.com/i.imgur.com/GGnDVP4.png?w=1170&#038;ssl=1" title="blobby!"><img src="https://i1.wp.com/i.imgur.com/GGnDVP4.png?w=1170&#038;ssl=1" alt="blobby!" /></a></p>

<p>Back to the main script file <strong>run.ps1</strong>, replace the default “hello world” sample code with the following:</p>

<pre><code class="language-PowerShell">$requestBody = Get-Content $req -Raw | ConvertFrom-Json
$fp = $EXECUTION_CONTEXT_FUNCTIONDIRECTORY
$config = Get-Content "$fp/appConfig.json" -Raw | ConvertFrom-Json
$graphConnectorURI = $config.basicConfig.graphConnectorURI
$tenant = $requestBody.tenant
$ver = $config.basicConfig.graphVer
$query = "deviceManagement/$($requestBody.query)"
$graphURI = "$($graphConnectorURI)&amp;tenant=$($tenant)&amp;Ver=$($ver)&amp;query=$($query)"

$objResult = Invoke-RestMethod -Method Get -Uri $graphURI
$objResult | ConvertTo-Json -Depth 20 | out-file -Encoding ascii -FilePath $outputBlob

if ($objResult) {
    $result = $true
}
else {
    $result = $false
}
$objReturn = [pscustomobject]@{
    Date = Get-Date -Format "yyyy-MM-ddTHH:mm:ss"
    Result = $result
}

$objReturn | ConvertTo-Json | out-file -Encoding ascii -FilePath $res
</code></pre>

<p>A quick breakdown of the code above - we are capturing the tenant details &amp; the final endpoint of the intune graphAPI from end-user input - I’ll show how this is done in the next step. Everything else is set up from the appConfig.json file. All we are doing is querying the GraphAPI (using our handy-dandy GraphConnector function), storing the resultant JSON file in our storage account and then sending the requestor a pass/fail object back.</p>

<p>To validate that this function is working how we want it, let’s go open the test pane and well… test it out!</p>

<p>For this demonstration, let’s just pull back the list of sidecar scripts in our Intune environment - use a tenant you have configured in your GraphConnector function and the query value as shown below:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"tenant"</span><span class="p">:</span><span class="s2">"contoso.com.au"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"deviceManagementScripts"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If all is good, you should receive the following in the output pane:</p>

<p><a href="https://i1.wp.com/i.imgur.com/JlQ37z8.png?w=1170&#038;ssl=1" title="success!"><img src="https://i1.wp.com/i.imgur.com/JlQ37z8.png?w=1170&#038;ssl=1" alt="success!" /></a></p>

<p>We can now validate that the blob file was created by going to the <strong>intunesnapshots</strong> in the Function App storage account and confirming that the file exists.</p>

<p><a href="https://i2.wp.com/i.imgur.com/bFfLI1u.png?w=1170&#038;ssl=1" title="More success"><img src="https://i2.wp.com/i.imgur.com/bFfLI1u.png?w=1170&#038;ssl=1" alt="More success" /></a></p>

<p>See how the name has been created using our tenant name &amp; the value of the query we provided in the test? The benefit of this is that we can query multiple tenants and multiple endpoints of the Intune environment and store everything inside the same location.</p>

<p>Alright, now we have our snapshots being created, let’s create a CRON Job Function to periodically monitor our Intune environment for any changes.</p>

<p>This time when creating the function, select <strong>Timer Trigger</strong>. Again as always, give the function a cool name, but this time, set up a schedule - for those who know their CRON expressions you won’t have any issues here. For those of you that see the sunlight from time to time, here’s a <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer#cron-expressions" rel="noopener" target="_blank">handy guide</a> on how Azure Function Apps expect the format.</p>

<p>In the below screenshot, I’ve set my schedule to run every hour.</p>

<p><a href="https://i2.wp.com/i.imgur.com/Je9zfXN.png?w=1170&#038;ssl=1" title="CRON Job"><img src="https://i2.wp.com/i.imgur.com/Je9zfXN.png?w=1170&#038;ssl=1" alt="CRON Job" /></a></p>

<p>As always, create yourself an appConfig.json file. You’ll want to get the URL of the container that you stored at the top of this guide and place it at the start of the currentSnapshot property, followed by the SAS code. The graphConnectorURI is the full function URL of the graphConnector function that you created from the last post.</p>

<p>Unlike in the last function, because we are triggering this script on a schedule where there will be no input, we will be placing the tenant details &amp; the query property in here as well - if you want to monitor multiple tenants, it is as simple as duplicating this function and updating the appConfig.json file.</p>

<p>Finally, the graphVer property is there because right now, most of the Intune config data is only accessible via the beta GraphAPI, this will eventually change, so it’s best to move this variable outside of the code for easy modification once it becomes GA.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"BasicConfig"</span><span class="p">:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"tenant"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"contoso.com.au"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"query"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"deviceManagementScripts"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"currentSnapshot"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://storageaccountURL.blob.core.windows.net/ContainerName/$($tenant)_$($query).json?SuperSecretSASCode"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"graphConnectorURI"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://graphconnectorPOC.azurewebsites.net/api/GraphConnector?code=SuperSecretCode"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"graphVer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"beta"</span><span class="w">
        </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now in the main script file, again as before, replace the default “hello world” sample code with the following:</p>

<pre><code class="language-PowerShell">$fp = $EXECUTION_CONTEXT_FUNCTIONDIRECTORY
$config = Get-Content "$fp/appConfig.json" -Raw | ConvertFrom-Json
$tenant = $config.basicConfig.tenant
$query = $config.basicConfig.query
$graphConnectorURI = $config.basicConfig.graphConnectorURI
$graphVer = $config.basicConfig.graphVer
$graphQuery = "deviceManagement/$($query)"
$currentSnapshot = $ExecutionContext.InvokeCommand.ExpandString($config.basicConfig.currentSnapshot)
Function Compare-ObjectProperties {
    # cleaned up from https://blogs.technet.microsoft.com/janesays/2017/04/25/compare-all-properties-of-two-objects-in-windows-powershell/
    Param(
        [PSObject]$ReferenceObject,
        [PSObject]$DifferenceObject
    )
    $objprops = $ReferenceObject | Get-Member -MemberType Property, NoteProperty | ForEach-Object Name
    $objprops += $DifferenceObject | Get-Member -MemberType Property, NoteProperty | ForEach-Object Name
    $objprops = $objprops | Sort-Object | Select-Object -Unique
    $diffs = @()
    foreach ($objprop in $objprops) {
        $diff = Compare-Object $ReferenceObject $DifferenceObject -Property $objprop
        if ($diff) {
            $diffprops = @{
                PropertyName = $objprop
                RefValue     = ($diff | Where-Object {$_.SideIndicator -eq '&lt;='} | ForEach-Object $($objprop))
                DiffValue    = ($diff | Where-Object {$_.SideIndicator -eq '=&gt;'} | ForEach-Object $($objprop))
            }
            $diffs += New-Object PSObject -Property $diffprops
        }
    }
    if ($diffs) {return ($diffs | Select-Object PropertyName, RefValue, DiffValue)}
}

$intuneSnapshot = Invoke-RestMethod -Uri $currentSnapshot

$graphURI = "$($graphConnectorURI)&amp;tenant=$($tenant)&amp;Ver=$($graphVer)&amp;query=$($graphQuery)"
$latestCapture = Invoke-RestMethod -Method Get -Uri $graphURI
$results = @()
for ($i = 0; $i -le ($intuneSnapshot.count - 1) ; $i ++) {
    $tmpCompare = Compare-ObjectProperties -ReferenceObject $intuneSnapshot[$i] -DifferenceObject $latestCapture[$i]
    if ($tmpCompare) {
        $tmpobject = [psCustomObject]@{
            TimeStamp         = Get-date -Format "yyyy-MM-ddTHH:mm:ss"
            Tenant            = $tenant
            ChangesFound      = $true
            SnapshotObject    = $intuneSnapshot[$i]
            ModifiedObject    = $latestCapture[$i]
            ChangedProperties = $tmpCompare
        }
        $results += $tmpobject
    }
}
if ($results) {
    return $results | ConvertTo-Json | out-file -encoding ascii -FilePath $res
}
else {
    $tmpObject = [psCustomObject]@{
        TimeStamp        = Get-date -Format "yyyy-MM-ddTHH:mm:ss"
        Tenant           = $tenant
        ChangesFound     = $false
    }
    return $tmpObject | ConvertTo-Json | out-file -encoding ascii -FilePath $res
}
</code></pre>

<p>Code above, again is fairly simple - the heavy lifting is done by the <strong>Compare-ObjectProperties</strong> function that appears on Jamie Nelson’s TechNet article (<a href="https://blogs.technet.microsoft.com/janesays/2017/04/25/compare-all-properties-of-two-objects-in-windows-powershell/" rel="noopener" target="_blank">found here</a>). What we are doing is simply loading up the snapshot JSON object, capturing a new copy of the intune config and comparing each property and its value. If there are any changes, they are noted and reported back to the requestor. If there are no changes found, that is also noted and sent back.</p>

<p>Alright, so let’s see this in action! Before we make any changes, let’s just make sure that when we trigger this new function that it confirms there are no changes. Run the code and you should receive the output as shown below.</p>

<p><a href="https://i2.wp.com/i.imgur.com/EP0Rhn8.png?w=1170&#038;ssl=1" title="Success - nothing changed"><img src="https://i2.wp.com/i.imgur.com/EP0Rhn8.png?w=1170&#038;ssl=1" alt="Success - nothing changed" /></a></p>

<p>ChangesFound = False.</p>

<p>Perfect - the script has run, compared itself against the snapshot and of course, nothing has changed.</p>

<p>Now, let’s break stuff.</p>

<p>I’ll go into my Intune environment and change one of our scripts to run as the logged on user instead of the system account (Nothing groundbreaking I know, but if this happened in a production environment, there’s a high chance the script would fail).</p>

<p><a href="https://i0.wp.com/i.imgur.com/Pkfe410.png?w=1170&#038;ssl=1" title="Very scary stuff"><img src="https://i0.wp.com/i.imgur.com/Pkfe410.png?w=1170&#038;ssl=1" alt="Very scary stuff" /></a></p>

<p>Alright, now we could wait an hour to see the function work, but let’s rush things along and force the script to run.</p>

<p>For this, I’m going to use PostMan because it handles the large amount of data we will be returning back better than the test pane does in Azure. Remember to grab the function URL from the Function App!</p>

<p>All you’ll need to do here is paste the URL into PostMan, set the method to <strong>post</strong> and hit <strong>send</strong>.</p>

<p><a href="https://i0.wp.com/i.imgur.com/QocK8cb.png?w=1170&#038;ssl=1" title="Changes ahoy"><img src="https://i0.wp.com/i.imgur.com/QocK8cb.png?w=1170&#038;ssl=1" alt="Changes ahoy" /></a></p>

<p>Success!! as you can see, we receive back very detailed information about the original snapshot configuration, what the new configuration looks like as well as an itemized breakdown of each value that changed!</p>

<p>Ahh but Ben, I hear you say, the current way that the monitoring script is configured, the resultant output will not have anywhere to go… It’s on a timer and it is designed to spit the output back to a requestor!</p>

<p>You are correct - but now that we know we can detect changes, lets mull over what we could possibly do now that we have all this power…</p>

<p>As always, code from this post will be available on my <a href="https://github.com/tabs-not-spaces/CodeDump/tree/master/IntuneMonitoring" rel="noopener" target="_blank">GitHub</a> and I always appreciate feedback, so either leave a comment below or reach me on twitter <a href="https://twitter.com/powers_hell" rel="noopener" target="_blank">@powers_hell</a></p>

<p>— Ben</p>

            </article>
        </div>
    </div><div class="main-overlay max-w-5xl mx-auto pb-4 overflow-hidden">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3537558222002149" crossorigin="anonymous"></script>
    <!-- horizontal-ad-unit -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3537558222002149" data-ad-slot="4617860412" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-cyan" />
    </div>
    <h2 class="drac-heading drac-heading-xl drac-text-cyan">Related Posts</h2>
    <ul class="related">
        
        <li><a href="/2018/08/17/authenticate-to-microsoft-graph-in-powershell-in-two-lines-of-code/"><span class="drac-text-cyan">&raquo;</span> Authenticate to Microsoft Graph in PowerShell in two lines of code!</a></li>
        
        <li><a href="/2018/05/15/working-with-graphapi-powerbi-the-easy-way/"><span class="drac-text-cyan">&raquo;</span> Working with GraphAPI & PowerBI the easy way!</a></li>
        
        <li><a href="/2021/12/27/manage-intune-trusted-certificate-profile-expiration-with-powershell/"><span class="drac-text-cyan">&raquo;</span> Manage Intune Trusted Certificate Profile Expiration with PowerShell & Microsoft Graph</a></li>
        
        <li><a href="/2021/06/16/create-advanced-dynamic-groups-with-powershell-azure-functions/"><span class="drac-text-cyan">&raquo;</span> Create advanced dynamic groups with PowerShell & Azure Functions</a></li>
        
        <li><a href="/2021/03/08/working-with-intune-settings-catalog-using-powershell-and-graph/"><span class="drac-text-cyan">&raquo;</span> Working with Intune Settings Catalog using PowerShell and Graph</a></li>
        
    </ul>
</div>
<div class="pagination main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center utterances">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-cyan" />
    </div>
    <script src="https://utteranc.es/client.js" repo="tabs-not-spaces/powers-hell-blog" issue-term="title" theme="github-dark" crossorigin="anonymous" async>
    </script>
</div></main>
  </div><script src="/assets/js/app.js"></script>
<script src="/assets/js/prism.js"></script>
<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">
</div>
<div>
    <svg class="wave" viewBox="0 0 1792 95.1" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path
            d="M1792,95.1c0-27,0-54,0-80.9c-40.7-5.1-101.2-11-174.5-12.3c-185.3-3.3-260.9,26.8-411.8,42.6
c-297.5,31.2-285-56-548.1-16.1C536.2,46.6,452.1,77.6,335.5,43C294,30.7,251,10.8,179.2,3C104.9-5,42.2,4.5,0,14.1v80.9H1792z" />
    </svg>
    <footer class="main-overlay drac-bg-blackBlack flex flex-wrap items-center justify-between p-3 m-auto">
        <div class="container mx-auto flex flex-col flex-wrap items-center justify-between">
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p class="drac-text-purple-cyan">
                        Powers Hell © 2022
                    </p>
                    <p class="footer-links drac-text-xs drac-text-yellow">
                        <a href ="https://github.com/tabs-not-spaces/powers-hell-blog/commit/dd6368cef1bd0330f5bfdcac10d91a59abaf833c" target="_blank">
                            dd6368c
                        </a>
                    </p>
                </span>
            </div>
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p>
                        made by
                        <a href="https://twitter.com/powers_hell" target="_blank" class="drac-text-yellow">
                            Ben
                        </a>
                        with
                        <a href="https://github.com/tabs-not-spaces" target="_blank"
                            class="drac-text-yellow-pink">
                            code, coffee & beer
                        </a>
                        🍻
                    </p>
                </span>
            </div>
        </div>
    </footer>
</div></body>

</html>