<!DOCTYPE html>
<html lang=" en" class="antialiased"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Authenticate to Graph directly from PowerBI! | Powers Hell</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Authenticate to Graph directly from PowerBI!" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Recently, one of my colleagues sent me a really cool Intune application patching report that they were working on and I wanted to see if I could make the data collection more automated / dynamic. Now, It’s been a LONG time since I’ve dipped my toes into the headache that is PowerBI, but once I see a challenge, it’s difficult for me to leave it alone… I’ve actually written about this before - back in 2018 I ran into the exact same problem - how do you authenticate to Graph to pull back data using a custom AAD application when PowerBI doesn’t allow you to specifically define your authentication parameters? At the time, I wrote about building a “middleware” solution that involved an Azure function application that handled the authentication as well as the Graph queries and simply returned the results back to the report. That solution still works just fine, but if we want people that aren’t nerds like me to actually use the reports, we ideally want a solution that has the authentication piece baked directly into the file. Well, it turns out all the pieces I need to have that work have been staring me in the face for years. Yes there is still no native way to define your authentication method, but with a little bit of work, you 110% can authenticate to Graph using any AAD application that you want. The secret of it all turns out to be quite simple. As I wrote about in my article about authenticating to Graph, if you know how the authentication requests are built, you can actually build the requests WITHOUT the libraries. Understanding that, we then need to simply build a way to have end users input their authentication parameters into a function that builds the authentication request for you. Luckily in PowerBI we can do this very easily (Sorry to all PowerBI nerds out there who already know this). All we need to do is prepare a few parameters and write a custom function query that will act as our tooling. Let’s start by creating a new empty report. We want to dive right into the guts of PowerBI, so select Transform data to enter the Power Query Editor. Now let’s create the necessary parameters we want the end user to populate. Right click on the queries pane and select New Parameter. We will then build out the following parameters. Feel free to put them into groups - It just looks so much neater. Parameter Name Type Current Value Tenant Id Text Your Tenant Id / Url Client Id Text Your AAD application Id Client Secret Text Your AAD appplication client secret Resource Text https://graph.microsoft.com Alright, now that we have our parameters, let’s build our first function. Select New Source &gt; Blank Query and then select Advanced Editor to bring up the editor. The code we will place into this new blank query is below. (_tenantId as text, _clientId as text, _clientSecret as text, _resource as text, _grantType as text, _scope as text) as text =&gt; let Url = &quot;https://login.microsoftonline.com/&quot;&amp;_tenantId&amp;&quot;/oauth2/token&quot;, Body = &quot;resource=&quot;&amp;_resource&amp;&quot;&amp;client_id=&quot;&amp;_clientId&amp;&quot;&amp;grant_type=&quot;&amp;_grantType&amp;&quot;&amp;scope=&quot;&amp;_scope&amp;&quot;&amp;client_secret=&quot;&amp;_clientSecret, Options = [ Content = Text.ToBinary(Body) ], Response = Web.Contents(Url,Options), ParsedJson = Json.Document(Response), ConvertedToken = &quot;Bearer &quot;&amp;ParsedJson[access_token] in ConvertedToken What we have above is actually quite simple: The first line defines the parameters and their types that will be accepted into our function. The rest of the code in the let segment simply builds out the request URL, request body &amp; posts the request. Finally, we pull out the access token from the response and prepend “Bearer” to it, so we can use it for any future queries. Now that we have our reusable function to authenticate, give the query a name (I’ve called mine “Get-AuthenticationHeader”), and let’s create another blank query and fill the advanced editor with the following code.. (GraphURL as text) =&gt; let AuthHeader = #&quot;Get-AuthenticationHeader&quot;(#&quot;Tenant Id&quot;, #&quot;Client Id&quot;, #&quot;Client Secret&quot;, Resource, &quot;client_credentials&quot;, &quot;openid&quot;), Options = [ Headers = [ Authorization = AuthHeader, #&quot;Content-Type&quot; = &quot;Application/Json&quot; ] ], WebRequestContent = Web.Contents(GraphURL,Options), JsonContent = Json.Document(WebRequestContent), ParsedResults = JsonContent[value], Converted = Table.FromList(ParsedResults, Splitter.SplitByNothing(), null, null, ExtraValues.Error), Expanded = Table.ExpandRecordColumn(Converted,&quot;Column1&quot;, Record.FieldNames(Converted[Column1]{0}), Record.FieldNames(Converted[Column1]{0})) in Expanded As with our authentication function, give this one a name (I’ve called mine “Invoke-GraphRequest”). What’s cool about the above function is it calls the first function for us, so that we only need to interface with the second function and provide a single parameter, which is the URL of the Graph endpoint we want to pull back into PowerBI. There’s a bit more going on after we pull back the data, specifically we convert the resultant data from a list of records to a table of data using the property names as the column names… Exciting stuff, right? OK - we now have two helper functions, let’s actually start pulling some data in. Let’s click on the Invoke-GraphRequest function and we should see a nice interface asking us to enter a parameter to insert into the function. I want to look at all the apps in my tenant, so I’m going to query https://graph.microsoft.com/beta/deviceAppManagement/mobileApps so I’ll put that address into the function and press invoke. FANCY!!!!!!!!! Looking at the code behind that this invoked function creates show’s us how simple things are now that we have abstracted out the process into two unique functions.. let Source = #&quot;Invoke-GraphRequest&quot;(&quot;https://graph.microsoft.com/beta/deviceAppManagement/mobileApps&quot;) in Source As you can see, we have a single request which is just invoking the second function we created with the single Graph URL as a parameter input. Now you have a simple framework to collect as many endpoint datasets as you want - just find what the endpoint URL is and build a query. There is a litte more that should be done before this is used in production - specifically, the second function should support paging so that it can collect all data available incase it is broken out into pages of data, but that should not be too hard to accomplish. Once I’ve written that I’ll come back and edit this post. If anyone else feels like figuring it out, feel free to leave the code in a comment below. But now the cool thing is, if we save this PowerBI report as a template and send it to someone, they will open it &amp; it will ask them to fill out the parameters, and as if by magic, will populate out the reports we generated! I personally can’t wait to close PowerBI and never open it again for another 5 years! Love this? Hate it? Have a better solution? Let me know on twitter or leave a comment below. For those who don’t want to build a template from scratch - don’t worry. I’ve put the template built from this post on GitHub. — Ben" />
<meta property="og:description" content="Recently, one of my colleagues sent me a really cool Intune application patching report that they were working on and I wanted to see if I could make the data collection more automated / dynamic. Now, It’s been a LONG time since I’ve dipped my toes into the headache that is PowerBI, but once I see a challenge, it’s difficult for me to leave it alone… I’ve actually written about this before - back in 2018 I ran into the exact same problem - how do you authenticate to Graph to pull back data using a custom AAD application when PowerBI doesn’t allow you to specifically define your authentication parameters? At the time, I wrote about building a “middleware” solution that involved an Azure function application that handled the authentication as well as the Graph queries and simply returned the results back to the report. That solution still works just fine, but if we want people that aren’t nerds like me to actually use the reports, we ideally want a solution that has the authentication piece baked directly into the file. Well, it turns out all the pieces I need to have that work have been staring me in the face for years. Yes there is still no native way to define your authentication method, but with a little bit of work, you 110% can authenticate to Graph using any AAD application that you want. The secret of it all turns out to be quite simple. As I wrote about in my article about authenticating to Graph, if you know how the authentication requests are built, you can actually build the requests WITHOUT the libraries. Understanding that, we then need to simply build a way to have end users input their authentication parameters into a function that builds the authentication request for you. Luckily in PowerBI we can do this very easily (Sorry to all PowerBI nerds out there who already know this). All we need to do is prepare a few parameters and write a custom function query that will act as our tooling. Let’s start by creating a new empty report. We want to dive right into the guts of PowerBI, so select Transform data to enter the Power Query Editor. Now let’s create the necessary parameters we want the end user to populate. Right click on the queries pane and select New Parameter. We will then build out the following parameters. Feel free to put them into groups - It just looks so much neater. Parameter Name Type Current Value Tenant Id Text Your Tenant Id / Url Client Id Text Your AAD application Id Client Secret Text Your AAD appplication client secret Resource Text https://graph.microsoft.com Alright, now that we have our parameters, let’s build our first function. Select New Source &gt; Blank Query and then select Advanced Editor to bring up the editor. The code we will place into this new blank query is below. (_tenantId as text, _clientId as text, _clientSecret as text, _resource as text, _grantType as text, _scope as text) as text =&gt; let Url = &quot;https://login.microsoftonline.com/&quot;&amp;_tenantId&amp;&quot;/oauth2/token&quot;, Body = &quot;resource=&quot;&amp;_resource&amp;&quot;&amp;client_id=&quot;&amp;_clientId&amp;&quot;&amp;grant_type=&quot;&amp;_grantType&amp;&quot;&amp;scope=&quot;&amp;_scope&amp;&quot;&amp;client_secret=&quot;&amp;_clientSecret, Options = [ Content = Text.ToBinary(Body) ], Response = Web.Contents(Url,Options), ParsedJson = Json.Document(Response), ConvertedToken = &quot;Bearer &quot;&amp;ParsedJson[access_token] in ConvertedToken What we have above is actually quite simple: The first line defines the parameters and their types that will be accepted into our function. The rest of the code in the let segment simply builds out the request URL, request body &amp; posts the request. Finally, we pull out the access token from the response and prepend “Bearer” to it, so we can use it for any future queries. Now that we have our reusable function to authenticate, give the query a name (I’ve called mine “Get-AuthenticationHeader”), and let’s create another blank query and fill the advanced editor with the following code.. (GraphURL as text) =&gt; let AuthHeader = #&quot;Get-AuthenticationHeader&quot;(#&quot;Tenant Id&quot;, #&quot;Client Id&quot;, #&quot;Client Secret&quot;, Resource, &quot;client_credentials&quot;, &quot;openid&quot;), Options = [ Headers = [ Authorization = AuthHeader, #&quot;Content-Type&quot; = &quot;Application/Json&quot; ] ], WebRequestContent = Web.Contents(GraphURL,Options), JsonContent = Json.Document(WebRequestContent), ParsedResults = JsonContent[value], Converted = Table.FromList(ParsedResults, Splitter.SplitByNothing(), null, null, ExtraValues.Error), Expanded = Table.ExpandRecordColumn(Converted,&quot;Column1&quot;, Record.FieldNames(Converted[Column1]{0}), Record.FieldNames(Converted[Column1]{0})) in Expanded As with our authentication function, give this one a name (I’ve called mine “Invoke-GraphRequest”). What’s cool about the above function is it calls the first function for us, so that we only need to interface with the second function and provide a single parameter, which is the URL of the Graph endpoint we want to pull back into PowerBI. There’s a bit more going on after we pull back the data, specifically we convert the resultant data from a list of records to a table of data using the property names as the column names… Exciting stuff, right? OK - we now have two helper functions, let’s actually start pulling some data in. Let’s click on the Invoke-GraphRequest function and we should see a nice interface asking us to enter a parameter to insert into the function. I want to look at all the apps in my tenant, so I’m going to query https://graph.microsoft.com/beta/deviceAppManagement/mobileApps so I’ll put that address into the function and press invoke. FANCY!!!!!!!!! Looking at the code behind that this invoked function creates show’s us how simple things are now that we have abstracted out the process into two unique functions.. let Source = #&quot;Invoke-GraphRequest&quot;(&quot;https://graph.microsoft.com/beta/deviceAppManagement/mobileApps&quot;) in Source As you can see, we have a single request which is just invoking the second function we created with the single Graph URL as a parameter input. Now you have a simple framework to collect as many endpoint datasets as you want - just find what the endpoint URL is and build a query. There is a litte more that should be done before this is used in production - specifically, the second function should support paging so that it can collect all data available incase it is broken out into pages of data, but that should not be too hard to accomplish. Once I’ve written that I’ll come back and edit this post. If anyone else feels like figuring it out, feel free to leave the code in a comment below. But now the cool thing is, if we save this PowerBI report as a template and send it to someone, they will open it &amp; it will ask them to fill out the parameters, and as if by magic, will populate out the reports we generated! I personally can’t wait to close PowerBI and never open it again for another 5 years! Love this? Hate it? Have a better solution? Let me know on twitter or leave a comment below. For those who don’t want to build a template from scratch - don’t worry. I’ve put the template built from this post on GitHub. — Ben" />
<link rel="canonical" href="https://powers-hell.com/2021/08/15/authenticate-to-graph-directly-from-powerbi/" />
<meta property="og:url" content="https://powers-hell.com/2021/08/15/authenticate-to-graph-directly-from-powerbi/" />
<meta property="og:site_name" content="Powers Hell" />
<meta property="og:image" content="https://powers-hell.com/assets/images/2021/08/PowerBI-FunctionInvoke.gif" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-15T08:38:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://powers-hell.com/assets/images/2021/08/PowerBI-FunctionInvoke.gif" />
<meta property="twitter:title" content="Authenticate to Graph directly from PowerBI!" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ben"},"description":"Recently, one of my colleagues sent me a really cool Intune application patching report that they were working on and I wanted to see if I could make the data collection more automated / dynamic. Now, It’s been a LONG time since I’ve dipped my toes into the headache that is PowerBI, but once I see a challenge, it’s difficult for me to leave it alone… I’ve actually written about this before - back in 2018 I ran into the exact same problem - how do you authenticate to Graph to pull back data using a custom AAD application when PowerBI doesn’t allow you to specifically define your authentication parameters? At the time, I wrote about building a “middleware” solution that involved an Azure function application that handled the authentication as well as the Graph queries and simply returned the results back to the report. That solution still works just fine, but if we want people that aren’t nerds like me to actually use the reports, we ideally want a solution that has the authentication piece baked directly into the file. Well, it turns out all the pieces I need to have that work have been staring me in the face for years. Yes there is still no native way to define your authentication method, but with a little bit of work, you 110% can authenticate to Graph using any AAD application that you want. The secret of it all turns out to be quite simple. As I wrote about in my article about authenticating to Graph, if you know how the authentication requests are built, you can actually build the requests WITHOUT the libraries. Understanding that, we then need to simply build a way to have end users input their authentication parameters into a function that builds the authentication request for you. Luckily in PowerBI we can do this very easily (Sorry to all PowerBI nerds out there who already know this). All we need to do is prepare a few parameters and write a custom function query that will act as our tooling. Let’s start by creating a new empty report. We want to dive right into the guts of PowerBI, so select Transform data to enter the Power Query Editor. Now let’s create the necessary parameters we want the end user to populate. Right click on the queries pane and select New Parameter. We will then build out the following parameters. Feel free to put them into groups - It just looks so much neater. Parameter Name Type Current Value Tenant Id Text Your Tenant Id / Url Client Id Text Your AAD application Id Client Secret Text Your AAD appplication client secret Resource Text https://graph.microsoft.com Alright, now that we have our parameters, let’s build our first function. Select New Source &gt; Blank Query and then select Advanced Editor to bring up the editor. The code we will place into this new blank query is below. (_tenantId as text, _clientId as text, _clientSecret as text, _resource as text, _grantType as text, _scope as text) as text =&gt; let Url = &quot;https://login.microsoftonline.com/&quot;&amp;_tenantId&amp;&quot;/oauth2/token&quot;, Body = &quot;resource=&quot;&amp;_resource&amp;&quot;&amp;client_id=&quot;&amp;_clientId&amp;&quot;&amp;grant_type=&quot;&amp;_grantType&amp;&quot;&amp;scope=&quot;&amp;_scope&amp;&quot;&amp;client_secret=&quot;&amp;_clientSecret, Options = [ Content = Text.ToBinary(Body) ], Response = Web.Contents(Url,Options), ParsedJson = Json.Document(Response), ConvertedToken = &quot;Bearer &quot;&amp;ParsedJson[access_token] in ConvertedToken What we have above is actually quite simple: The first line defines the parameters and their types that will be accepted into our function. The rest of the code in the let segment simply builds out the request URL, request body &amp; posts the request. Finally, we pull out the access token from the response and prepend “Bearer” to it, so we can use it for any future queries. Now that we have our reusable function to authenticate, give the query a name (I’ve called mine “Get-AuthenticationHeader”), and let’s create another blank query and fill the advanced editor with the following code.. (GraphURL as text) =&gt; let AuthHeader = #&quot;Get-AuthenticationHeader&quot;(#&quot;Tenant Id&quot;, #&quot;Client Id&quot;, #&quot;Client Secret&quot;, Resource, &quot;client_credentials&quot;, &quot;openid&quot;), Options = [ Headers = [ Authorization = AuthHeader, #&quot;Content-Type&quot; = &quot;Application/Json&quot; ] ], WebRequestContent = Web.Contents(GraphURL,Options), JsonContent = Json.Document(WebRequestContent), ParsedResults = JsonContent[value], Converted = Table.FromList(ParsedResults, Splitter.SplitByNothing(), null, null, ExtraValues.Error), Expanded = Table.ExpandRecordColumn(Converted,&quot;Column1&quot;, Record.FieldNames(Converted[Column1]{0}), Record.FieldNames(Converted[Column1]{0})) in Expanded As with our authentication function, give this one a name (I’ve called mine “Invoke-GraphRequest”). What’s cool about the above function is it calls the first function for us, so that we only need to interface with the second function and provide a single parameter, which is the URL of the Graph endpoint we want to pull back into PowerBI. There’s a bit more going on after we pull back the data, specifically we convert the resultant data from a list of records to a table of data using the property names as the column names… Exciting stuff, right? OK - we now have two helper functions, let’s actually start pulling some data in. Let’s click on the Invoke-GraphRequest function and we should see a nice interface asking us to enter a parameter to insert into the function. I want to look at all the apps in my tenant, so I’m going to query https://graph.microsoft.com/beta/deviceAppManagement/mobileApps so I’ll put that address into the function and press invoke. FANCY!!!!!!!!! Looking at the code behind that this invoked function creates show’s us how simple things are now that we have abstracted out the process into two unique functions.. let Source = #&quot;Invoke-GraphRequest&quot;(&quot;https://graph.microsoft.com/beta/deviceAppManagement/mobileApps&quot;) in Source As you can see, we have a single request which is just invoking the second function we created with the single Graph URL as a parameter input. Now you have a simple framework to collect as many endpoint datasets as you want - just find what the endpoint URL is and build a query. There is a litte more that should be done before this is used in production - specifically, the second function should support paging so that it can collect all data available incase it is broken out into pages of data, but that should not be too hard to accomplish. Once I’ve written that I’ll come back and edit this post. If anyone else feels like figuring it out, feel free to leave the code in a comment below. But now the cool thing is, if we save this PowerBI report as a template and send it to someone, they will open it &amp; it will ask them to fill out the parameters, and as if by magic, will populate out the reports we generated! I personally can’t wait to close PowerBI and never open it again for another 5 years! Love this? Hate it? Have a better solution? Let me know on twitter or leave a comment below. For those who don’t want to build a template from scratch - don’t worry. I’ve put the template built from this post on GitHub. — Ben","url":"https://powers-hell.com/2021/08/15/authenticate-to-graph-directly-from-powerbi/","@type":"BlogPosting","headline":"Authenticate to Graph directly from PowerBI!","dateModified":"2021-08-15T08:38:00+00:00","datePublished":"2021-08-15T08:38:00+00:00","image":"https://powers-hell.com/assets/images/2021/08/PowerBI-FunctionInvoke.gif","mainEntityOfPage":{"@type":"WebPage","@id":"https://powers-hell.com/2021/08/15/authenticate-to-graph-directly-from-powerbi/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/prism-dracula.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>
    <script data-ad-client="ca-pub-3537558222002149" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SGKQTF5F0T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SGKQTF5F0T');
</script>
    <style type="text/css">
        :root {
            --dynamic-page-color: green;
        }
    </style>
</head><body><div class="page-container">
    <div class="">
        <nav x-data="{ open: false }" class="nav sticky drac-bg-blackBlack">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 link-hover">
                            <h2 class="drac-heading drac-heading-xl"><a href="/">Powers Hell</a></h2>
                        </div>
                        <div class="hidden md:block flex-shrink-0">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <div id="tagalign" class="drac-text drac-text-cyan drac-text-right drac-line-height">
                                    great/power/is/great/fun >
                                    <div class="cursor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block flex-shrink-0">
                        <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                    </div>
                    <div class="mr-2 flex md:hidden">
                        <!-- Mobile menu button -->
                        <button type="button"
                            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm items-center justify-center p-2"
                            aria-controls="mobile-menu" aria-expanded="false" @click="open = !open" ara-expanded="false"
                            x-bind-aria-expanded="open.toString()">
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'hidden':open, 'block': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>

                            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'block':open, 'hidden': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="drac-bg-black md:hidden" x-show.transition="open">
                <div class="px-2 py-3 space-y-1 sm:px-3 items-center">
                    <div id="tagalign" class="ml-3 drac-text drac-text-cyan drac-line-height">
                        great/power/is/great/fun >
                        <div class="cursor"></div>
                    </div>
                    <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                </div>
            </div>
        </nav>
      <div class="drac-bg-blackBlack pb-6 md:pb-24 lg:pb-28 xl:pb-8">
        <header class="py-10"><div class="main-overlay max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <h1
        class="drac-heading drac-heading-2xl drac-text-center drac-text-green">
        
        Authenticate to Graph directly from PowerBI!
        
    </h1>
    
</div></header>
      </div>
      <div>
        <svg class="wave" viewBox="0 0 1792 335" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path d="M 0 50 C 259 50 259 209 518 209 L 518 209 L 518 0 L 0 0 Z" stroke-width="0"></path>
        <path d="M 517 209 C 800 209 800 96 1083 96 L 1083 96 L 1083 0 L 517 0 Z" stroke-width="0"></path>
        <path d="M 1082 96 C 1437 96 1437 189 1792 189 L 1792 189 L 1792 0 L 1082 0 Z" stroke-width="0"></path>
        </svg>
      </div><main class="-mt-4 md:-mt-64 lg:-mt-72 xl:-mt-80 2xl:-mt-96 4xl:-mt-112">
    <div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
        <div class=" break-normal md:break-word drac-bg-black rounded-lg shadow-2xl px-5 py-6 sm:px-6">
            <article class="markdown-body drac-text drac-line-height line-numbers">

                <p class="post-date drac-text drac-text-xs"><font class="drac-text-black-secondary">Published:</font>
                    <font class="drac-text-green"> 15 Aug 2021</font>
                    <br/>
                    <font class="drac-text-black-secondary">File under:</font>
<font class="drac-text drac-text-xs">
    <a href="/category/automation/" class="related">Automation</a>, <a href="/category/graph/" class="related">Graph</a>, <a href="/category/intune/" class="related">Intune</a>, <a href="/category/powerbi/" class="related">PowerBI</a>,  <a href="/category/reporting/" class="related">Reporting</a></font></p>
                
                <span>
          <a href="/assets/images/2021/08/PowerBI-FunctionInvoke.gif" title="Hero Image"><img src="/assets/images/2021/08/PowerBI-FunctionInvoke.gif" alt="Authenticate to Graph directly from PowerBI!"></a>
        </span>  <p>Recently, one of my colleagues sent me a really cool Intune application patching report that they were working on and I wanted to see if I could make the data collection more automated / dynamic. Now, It’s been a LONG time since I’ve dipped my toes into the headache that is PowerBI, but once I see a challenge, it’s difficult for me to leave it alone…</p>

<p><a href="/2018/05/15/working-with-graphapi-powerbi-the-easy-way/">I’ve actually written about this before</a> - back in 2018 I ran into the exact same problem - how do you authenticate to Graph to pull back data using a custom AAD application when PowerBI doesn’t allow you to specifically define your authentication parameters?</p>

<p>At the time, I wrote about building a “middleware” solution that involved an Azure function application that handled the authentication as well as the Graph queries and simply returned the results back to the report. That solution still works just fine, but if we want people that aren’t nerds like me to actually use the reports, we ideally want a solution that has the authentication piece baked directly into the file.</p>

<p>Well, it turns out all the pieces I need to have that work have been staring me in the face for years. Yes there is still no native way to define your authentication method, but with a little bit of work, you 110% can authenticate to Graph using any AAD application that you want.</p>

<p>The secret of it all turns out to be quite simple. <a href="/2018/08/17/authenticate-to-microsoft-graph-in-powershell-in-two-lines-of-code/">As I wrote about in my article about authenticating to Graph</a>, if you know how the authentication requests are built, you can actually build the requests <strong>WITHOUT</strong> the libraries. Understanding that, we then need to simply build a way to have end users input their authentication parameters into a function that builds the authentication request for you.</p>

<p>Luckily in PowerBI we can do this very easily (Sorry to all PowerBI nerds out there who already know this). All we need to do is prepare a few parameters and write a custom function query that will act as our tooling.</p>

<p>Let’s start by creating a new empty report. We want to dive right into the guts of PowerBI, so select <strong>Transform data</strong> to enter the <strong>Power Query Editor</strong>.</p>

<p>Now let’s create the necessary parameters we want the end user to populate. Right click on the queries pane and select <strong>New Parameter</strong>. We will then build out the following parameters. Feel free to put them into groups - It just looks so much neater.</p>

<table>
  <thead>
    <tr>
      <th>Parameter Name</th>
      <th>Type</th>
      <th>Current Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Tenant Id</td>
      <td>Text</td>
      <td>Your Tenant Id / Url</td>
    </tr>
    <tr>
      <td>Client Id</td>
      <td>Text</td>
      <td>Your AAD application Id</td>
    </tr>
    <tr>
      <td>Client Secret</td>
      <td>Text</td>
      <td>Your AAD appplication client secret</td>
    </tr>
    <tr>
      <td>Resource</td>
      <td>Text</td>
      <td>https://graph.microsoft.com</td>
    </tr>
  </tbody>
</table>

<p><a href="/assets/images/2021/08/PowerBI-Parameters.gif" title="Building Parameters"><img src="/assets/images/2021/08/PowerBI-Parameters.gif" alt="Building Parameters" /></a></p>

<p>Alright, now that we have our parameters, let’s build our first function. Select <strong>New Source &gt; Blank Query</strong> and then select <strong>Advanced Editor</strong> to bring up the editor. The code we will place into this new blank query is below.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="err">_</span><span class="n">tenantId</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="err">_</span><span class="n">clientId</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="err">_</span><span class="n">clientSecret</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="err">_</span><span class="n">resource</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="err">_</span><span class="n">grantType</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="err">_</span><span class="n">scope</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span><span class="n">let</span><span class="w">
    </span><span class="n">Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://login.microsoftonline.com/"</span><span class="o">&amp;</span><span class="err">_</span><span class="n">tenantId</span><span class="o">&amp;</span><span class="s2">"/oauth2/token"</span><span class="p">,</span><span class="w">
    </span><span class="n">Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"resource="</span><span class="o">&amp;</span><span class="err">_</span><span class="n">resource</span><span class="o">&amp;</span><span class="s2">"&amp;client_id="</span><span class="o">&amp;</span><span class="err">_</span><span class="n">clientId</span><span class="o">&amp;</span><span class="s2">"&amp;grant_type="</span><span class="o">&amp;</span><span class="err">_</span><span class="n">grantType</span><span class="o">&amp;</span><span class="s2">"&amp;scope="</span><span class="o">&amp;</span><span class="err">_</span><span class="n">scope</span><span class="o">&amp;</span><span class="s2">"&amp;client_secret="</span><span class="o">&amp;</span><span class="err">_</span><span class="n">clientSecret</span><span class="p">,</span><span class="w">
    </span><span class="n">Options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="n">Content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Text.ToBinary</span><span class="p">(</span><span class="n">Body</span><span class="p">)</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Web.Contents</span><span class="p">(</span><span class="n">Url</span><span class="p">,</span><span class="n">Options</span><span class="p">),</span><span class="w">
    </span><span class="n">ParsedJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Json.Document</span><span class="p">(</span><span class="n">Response</span><span class="p">),</span><span class="w">
    </span><span class="n">ConvertedToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer "</span><span class="o">&amp;</span><span class="n">ParsedJson</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span><span class="w">
</span><span class="k">in</span><span class="w">
    </span><span class="n">ConvertedToken</span><span class="w">
</span></code></pre></div></div>

<p>What we have above is actually quite simple:</p>
<ul>
  <li>The first line defines the parameters and their types that will be accepted into our function.</li>
  <li>The rest of the code in the <strong>let</strong> segment simply builds out the request URL, request body &amp; posts the request.</li>
  <li>Finally, we pull out the <strong>access token</strong> from the response and prepend “Bearer” to it, so we can use it for any future queries.</li>
</ul>

<p>Now that we have our reusable function to authenticate, give the query a name (I’ve called mine “Get-AuthenticationHeader”), and let’s create <strong>another</strong> blank query and fill the advanced editor with the following code..</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">GraphURL</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">
</span><span class="n">let</span><span class="w">
    </span><span class="n">AuthHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">#"Get-AuthenticationHeader"(#"Tenant Id", #"Client Id", #"Client Secret", Resource, "client_credentials", "openid"),</span><span class="w">
    </span><span class="n">Options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="n">Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="n">Authorization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthHeader</span><span class="p">,</span><span class="w">
            </span><span class="c1">#"Content-Type" = "Application/Json"</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="n">WebRequestContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Web.Contents</span><span class="p">(</span><span class="n">GraphURL</span><span class="p">,</span><span class="n">Options</span><span class="p">),</span><span class="w">
    </span><span class="n">JsonContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Json.Document</span><span class="p">(</span><span class="n">WebRequestContent</span><span class="p">),</span><span class="w">
    </span><span class="n">ParsedResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonContent</span><span class="p">[</span><span class="n">value</span><span class="p">],</span><span class="w">
    </span><span class="n">Converted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table.FromList</span><span class="p">(</span><span class="n">ParsedResults</span><span class="p">,</span><span class="w"> </span><span class="n">Splitter.SplitByNothing</span><span class="p">(),</span><span class="w"> </span><span class="n">null</span><span class="p">,</span><span class="w"> </span><span class="n">null</span><span class="p">,</span><span class="w"> </span><span class="n">ExtraValues.Error</span><span class="p">),</span><span class="w">
    </span><span class="n">Expanded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Table.ExpandRecordColumn</span><span class="p">(</span><span class="n">Converted</span><span class="p">,</span><span class="s2">"Column1"</span><span class="p">,</span><span class="w">
                    </span><span class="n">Record.FieldNames</span><span class="p">(</span><span class="n">Converted</span><span class="p">[</span><span class="n">Column1</span><span class="p">]{</span><span class="m">0</span><span class="p">}),</span><span class="w">
                    </span><span class="n">Record.FieldNames</span><span class="p">(</span><span class="n">Converted</span><span class="p">[</span><span class="n">Column1</span><span class="p">]{</span><span class="m">0</span><span class="p">}))</span><span class="w">
</span><span class="k">in</span><span class="w">
    </span><span class="n">Expanded</span><span class="w">
</span></code></pre></div></div>

<p>As with our authentication function, give this one a name (I’ve called mine “Invoke-GraphRequest”).</p>

<p>What’s cool about the above function is it calls the first function for us, so that we only need to interface with the second function and provide a single parameter, which is the URL of the Graph endpoint we want to pull back into PowerBI.</p>

<p>There’s a bit more going on after we pull back the data, specifically we convert the resultant data from a list of records to a table of data using the property names as the column names… Exciting stuff, right?</p>

<p>OK - we now have two helper functions, let’s actually start pulling some data in. Let’s click on the <strong>Invoke-GraphRequest</strong> function and we should see a nice interface asking us to enter a parameter to insert into the function. I want to look at all the apps in my tenant, so I’m going to query <code class="language-plaintext highlighter-rouge">https://graph.microsoft.com/beta/deviceAppManagement/mobileApps</code> so I’ll put that address into the function and press <strong>invoke</strong>.</p>

<p><a href="/assets/images/2021/08/PowerBI-FunctionInvoke.gif" title="Invoke-GraphRequest"><img src="/assets/images/2021/08/PowerBI-FunctionInvoke.gif" alt="Invoke-GraphRequest" /></a></p>

<p>FANCY!!!!!!!!!</p>

<p>Looking at the <em>code behind</em> that this invoked function creates show’s us how simple things are now that we have abstracted out the process into two unique functions..</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span><span class="w">
    </span><span class="n">Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">#"Invoke-GraphRequest"("https://graph.microsoft.com/beta/deviceAppManagement/mobileApps")</span><span class="w">
</span><span class="k">in</span><span class="w">
    </span><span class="n">Source</span><span class="w">
</span></code></pre></div></div>

<p>As you can see, we have a single request which is just invoking the second function we created with the single Graph URL as a parameter input.</p>

<p>Now you have a simple framework to collect as many endpoint datasets as you want - just find what the endpoint URL is and build a query.</p>

<p>There is a litte more that should be done before this is used in production - specifically, the second function should support paging so that it can collect all data available incase it is broken out into pages of data, but that should not be too hard to accomplish. Once I’ve written that I’ll come back and edit this post. If anyone else feels like figuring it out, feel free to leave the code in a comment below.</p>

<p>But now the cool thing is, if we save this PowerBI report as a template and send it to someone, they will open it &amp; it will ask them to fill out the parameters, and as if by magic, will populate out the reports we generated!</p>

<p><a href="/assets/images/2021/08/PowerBI-Template.gif" title="Open Template And Build Report"><img src="/assets/images/2021/08/PowerBI-Template.gif" alt="Open Template And Build Report" /></a></p>

<p>I personally can’t wait to close PowerBI and never open it again for another 5 years!</p>

<p>Love this? Hate it? Have a better solution? Let me know on <a href="https://twitter.com/powers_hell">twitter</a> or leave a comment below.</p>

<p>For those who don’t want to build a template from scratch - don’t worry. <a href="https://github.com/tabs-not-spaces/CodeDump/tree/master/PowerBI-GraphAuthentication">I’ve put the template built from this post on GitHub.</a></p>

<p>— Ben</p>


            </article>
        </div>
    </div><div class="main-overlay max-w-5xl mx-auto pb-4 overflow-hidden">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3537558222002149" crossorigin="anonymous"></script>
    <!-- horizontal-ad-unit -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3537558222002149" data-ad-slot="4617860412" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-green" />
    </div>
    <h2 class="drac-heading drac-heading-xl drac-text-green">Related Posts</h2>
    <ul class="related">
        
        <li><a href="/2021/07/04/create-assign-filters-with-powershell-graph/"><span class="drac-text-green">&raquo;</span> Create & assign filters with PowerShell & Graph</a></li>
        
        <li><a href="/2021/01/19/publishing-powershell-scripts-to-intune-with-graph/"><span class="drac-text-green">&raquo;</span> Publishing PowerShell scripts to Intune with Graph</a></li>
        
        <li><a href="/2018/05/15/working-with-graphapi-powerbi-the-easy-way/"><span class="drac-text-green">&raquo;</span> Working with GraphAPI & PowerBI the easy way!</a></li>
        
        <li><a href="/2021/07/18/authenticating-to-microsoft-graph-with-powershell-(2021)/"><span class="drac-text-green">&raquo;</span> Authenticating to Microsoft Graph with PowerShell - (2021)</a></li>
        
        <li><a href="/2020/04/21/creating-endpoint-security-policies-with-powershell/"><span class="drac-text-green">&raquo;</span> Creating Endpoint Security Policies with PowerShell</a></li>
        
    </ul>
</div>
<div class="pagination main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center utterances">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-green" />
    </div>
    <script src="https://utteranc.es/client.js" repo="tabs-not-spaces/powers-hell-blog" issue-term="title" theme="github-dark" crossorigin="anonymous" async>
    </script>
</div></main>
  </div><script src="/assets/js/app.js"></script>
<script src="/assets/js/prism.js"></script>
<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">
</div>
<div>
    <svg class="wave" viewBox="0 0 1792 95.1" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path
            d="M1792,95.1c0-27,0-54,0-80.9c-40.7-5.1-101.2-11-174.5-12.3c-185.3-3.3-260.9,26.8-411.8,42.6
c-297.5,31.2-285-56-548.1-16.1C536.2,46.6,452.1,77.6,335.5,43C294,30.7,251,10.8,179.2,3C104.9-5,42.2,4.5,0,14.1v80.9H1792z" />
    </svg>
    <footer class="main-overlay drac-bg-blackBlack flex flex-wrap items-center justify-between p-3 m-auto">
        <div class="container mx-auto flex flex-col flex-wrap items-center justify-between">
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p class="drac-text-purple-cyan">
                        Powers Hell © 2021
                    </p>
                </span>
            </div>
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p>
                        made by
                        <a href="https://twitter.com/powers_hell" target="_blank" class="drac-text-yellow">
                            Ben
                        </a>
                        with
                        <a href="https://github.com/tabs-not-spaces/powers-hell-blog" target="_blank"
                            class="drac-text-yellow-pink">
                            code, coffee & beer
                        </a>
                        🍻
                    </p>
                </span>
            </div>
        </div>
    </footer>
</div></body>

</html>