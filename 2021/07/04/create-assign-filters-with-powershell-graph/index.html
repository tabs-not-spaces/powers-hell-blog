<!DOCTYPE html>
<html lang=" en" class="antialiased"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Create &amp; assign filters with PowerShell &amp; Graph | Powers Hell</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Create &amp; assign filters with PowerShell &amp; Graph" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="As I’ve said before, working with dynamic groups in Intune isn’t my favourite thing. Luckily, Microsoft has been listening and have provided us with a better way to dynamically apply policies to devices with filters!" />
<meta property="og:description" content="As I’ve said before, working with dynamic groups in Intune isn’t my favourite thing. Luckily, Microsoft has been listening and have provided us with a better way to dynamically apply policies to devices with filters!" />
<link rel="canonical" href="https://powers-hell.com/2021/07/04/create-assign-filters-with-powershell-graph/" />
<meta property="og:url" content="https://powers-hell.com/2021/07/04/create-assign-filters-with-powershell-graph/" />
<meta property="og:site_name" content="Powers Hell" />
<meta property="og:image" content="https://powers-hell.com/assets/images/2021/07/image2.gif" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-04T02:17:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://powers-hell.com/assets/images/2021/07/image2.gif" />
<meta property="twitter:title" content="Create &amp; assign filters with PowerShell &amp; Graph" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ben"},"description":"As I’ve said before, working with dynamic groups in Intune isn’t my favourite thing. Luckily, Microsoft has been listening and have provided us with a better way to dynamically apply policies to devices with filters!","url":"https://powers-hell.com/2021/07/04/create-assign-filters-with-powershell-graph/","@type":"BlogPosting","image":"https://powers-hell.com/assets/images/2021/07/image2.gif","headline":"Create &amp; assign filters with PowerShell &amp; Graph","dateModified":"2021-07-04T02:17:00+00:00","datePublished":"2021-07-04T02:17:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://powers-hell.com/2021/07/04/create-assign-filters-with-powershell-graph/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/prism-dracula.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js" defer></script>
    <script data-ad-client="ca-pub-3537558222002149" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SGKQTF5F0T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SGKQTF5F0T');
</script>
    <style type="text/css">
        :root {
            --dynamic-page-color: yellow;
        }
    </style>
</head><body><div class="page-container">
    <div class="">
        <nav x-data="{ open: false }" class="nav sticky drac-bg-blackBlack">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 link-hover">
                            <h2 class="drac-heading drac-heading-xl"><a href="/">Powers Hell</a></h2>
                        </div>
                        <div class="hidden md:block flex-shrink-0">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <div id="tagalign" class="drac-text drac-text-cyan drac-text-right drac-line-height">
                                    great/power/is/great/fun >
                                    <div class="cursor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block flex-shrink-0">
                        <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                    </div>
                    <div class="mr-2 flex md:hidden">
                        <!-- Mobile menu button -->
                        <button type="button"
                            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm items-center justify-center p-2"
                            aria-controls="mobile-menu" aria-expanded="false" @click="open = !open" ara-expanded="false"
                            x-bind-aria-expanded="open.toString()">
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'hidden':open, 'block': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>

                            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" x-state:on="Menu open"
                                x-state:off="Menu closed" :class="{ 'block':open, 'hidden': !(open) }">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="drac-bg-black md:hidden" x-show.transition="open">
                <div class="px-2 py-3 space-y-1 sm:px-3 items-center">
                    <div id="tagalign" class="ml-3 drac-text drac-text-cyan drac-line-height">
                        great/power/is/great/fun >
                        <div class="cursor"></div>
                    </div>
                    <div class="block md:hidden">
    <div class="ml-3 items-center relative">
        <a href="/"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/about"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/archives"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Archives</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="/categories"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Categories</a>
    </div>
    <div class="ml-3 items-center relative">
        <a href="https://merch.powers-hell.com"
            class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
    </div>
</div>
<div class="hidden md:block">
    <a href="/"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm">Home</a>
<a href="/about"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
<a href="https://merch.powers-hell.com"
    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
</div>



                </div>
            </div>
        </nav>
      <div class="drac-bg-blackBlack pb-6 md:pb-24 lg:pb-28 xl:pb-8">
        <header class="py-10"><div class="main-overlay max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <h1
        class="drac-heading drac-heading-2xl drac-text-center drac-text-yellow">
        
        Create & assign filters with PowerShell & Graph
        
    </h1>
    
</div></header>
      </div>
      <div>
        <svg class="wave" viewBox="0 0 1792 335" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path d="M 0 50 C 259 50 259 209 518 209 L 518 209 L 518 0 L 0 0 Z" stroke-width="0"></path>
        <path d="M 517 209 C 800 209 800 96 1083 96 L 1083 96 L 1083 0 L 517 0 Z" stroke-width="0"></path>
        <path d="M 1082 96 C 1437 96 1437 189 1792 189 L 1792 189 L 1792 0 L 1082 0 Z" stroke-width="0"></path>
        </svg>
      </div><main class="-mt-4 md:-mt-64 lg:-mt-72 xl:-mt-80 2xl:-mt-96 4xl:-mt-112">
    <div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
        <div class=" break-normal md:break-word drac-bg-black rounded-lg shadow-2xl px-5 py-6 sm:px-6">
            <article class="markdown-body drac-text drac-line-height line-numbers">

                <p class="post-date drac-text drac-text-xs"><font class="drac-text-black-secondary">Published:</font>
                    <font class="drac-text-yellow"> 4 Jul 2021</font>
                    <br/>
                    <font class="drac-text-black-secondary">File under:</font>
<font class="drac-text drac-text-xs">
    <a href="/category/automation/" class="related">Automation</a>, <a href="/category/graph/" class="related">Graph</a>, <a href="/category/intune/" class="related">Intune</a>,  <a href="/category/powershell/" class="related">PowerShell</a></font></p>
                
                <span>
          <a href="/assets/images/2021/07/image2.gif" title="Hero Image"><img src="/assets/images/2021/07/image2.gif" alt="Create & assign filters with PowerShell & Graph"></a>
        </span>  <p>As I’ve said before, working with dynamic groups in Intune <a href="/2021/06/16/create-advanced-dynamic-groups-with-powershell-azure-functions/">isn’t my favourite thing</a>.</p>

<p>Luckily, Microsoft has been listening and have provided us with a better way to dynamically apply policies to devices with <a href="https://docs.microsoft.com/en-us/mem/intune/fundamentals/filters">filters!</a></p>

<!--more-->

<p>I recently sat down with <a href="https://twitter.com/scottduf">Scott Duffey</a> (who brought us this amazing new feature) to dive into how filters work and how they can improve our endpoint management workflows.</p>

<div class="video-container">
<iframe width="560" height="315" src="https://www.youtube.com/embed/_UuMfbvY8hw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media;" allowfullscreen=""></iframe>
</div>

<p>As is always the case, after finishing our chat, I immediately wanted to figure out how to work with Filters in a more programmatic way. Turns out, it was super easy!</p>

<h2 id="overview">Overview</h2>

<p>At a high level, what makes filters so much better for use in Intune comes down to two primary factors.</p>

<ol>
  <li>The filter evaluation is done when the device enrolls, checks in with the Intune service or basically any time a policy is evaluated - which means the speed of evaluation is <em>significantly</em> faster than that of dynamic groups.</li>
  <li>Filters are decoupled from groups, which means they are now <strong>reusable</strong>. This means we can now create <strong>one</strong> filter and use it for <strong>many</strong> policies!</li>
</ol>

<p>So let’s get started and create our first filter.</p>

<h2 id="create-a-filter">Create a filter</h2>

<h5 id="authenticate">Authenticate</h5>

<p>As we are using PowerShell &amp; Graph, we will need to authenticate.</p>

<p>Using the MSAL.PS module makes this easy.</p>

<pre><code class="language-PowerShell">$authParams = @{
    ClientId    = 'd1ddf0e4-d672-4dae-b554-9d5bdfd93547'
    TenantId    = 'powers-hell.com'
    DeviceCode  = $true
}
$authToken = Get-MsalToken @authParams
</code></pre>

<h5 id="build-and-post">Build and post</h5>

<p>Now we need to build out a new filter object to post to Graph. This is just a simple json object that we will publish to the <strong>assignedFilters</strong> endpoint.</p>

<p>For this example we want a filter that finds all corporate owned virtual machines.</p>

<pre><code class="language-PowerShell">$filter = @{
    displayName = 'Example Filter'
    description = 'This filter will select all virtual machines'
    platform    = 'Windows10AndLater'
    rule        = '(device.deviceOwnership -eq "Corporate") and (device.model -startsWith "Virtual Machine")'
} | ConvertTo-Json -Depth 10
</code></pre>
<p>As you can see from above, the actual request body is quite simple. The actual filter rule uses the same syntax and formatting as dynamic rules, so the learning curve is quite low.</p>

<p>Now lets post our filter to graph.</p>

<pre><code class="language-PowerShell">$baseGraphUri = 'https://graph.microsoft.com/beta/deviceManagement/assignmentFilters'
$graphParams = @{
    Method          = 'Post'
    Uri             = $baseGraphUri
    Authentication  = 'OAuth'
    Token           = $authToken.AccessToken | ConvertTo-SecureString -AsPlainText -Force
    ContentType     = 'Application/Json'
    Body            = $filter
}
Invoke-RestMethod @graphParams
</code></pre>

<p>If successful, we should see the results of the post sent back to us. Make note of the returned id, and let’s move on!</p>

<p><a href="/assets/images/2021/07/image1.gif" title="Successful filter post"><img src="/assets/images/2021/07/image1.gif" alt="Successful filter post" /></a></p>

<h2 id="assign-a-filter">Assign a filter</h2>

<p>Now that we’ve got our filter created, let’s assign it to a policy. In this example, I’ve got an application I want to deploy (as required) to all of my virtual machines. To make sure I capture all possible virtual machines, I’ll assign the application to <strong>all devices</strong> and then filter down to the virtual machines using the filter object we’ve already created.</p>

<p>The first most obvious thing we need to do is know what the id of the policy is that we want. The easiest way to get that is to simply go to the policy in the endpoint portal.</p>

<p>Once you’ve got both the policy id and the filter id (from the creation steps above) , all that we need to do is build another post request to graph.</p>

<p>First, let’s build the body of the post.</p>

<pre><code class="language-PowerShell">$filterId = '2727f0f4-d030-4792-8aba-b6ef5efe602d' #your filter id
$assignments = @{
    mobileAppAssignments = @(
        @{
            '@odata.type' = '#microsoft.graph.mobileAppAssignment'
            intent        = 'Required'
            target        = @{
                '@odata.type'                              = '#microsoft.graph.allDevicesAssignmentTarget'
                deviceAndAppManagementAssignmentFilterId   = $filterId
                deviceAndAppManagementAssignmentFilterType = 'include'
            }
        }
    )
} | ConvertTo-Json -Depth 10
</code></pre>

<p>This is a <em>little</em> more complicated that the previous request we built, but only because we are dealing with nested objects. Simply speaking, all we are doing is creting a new <strong>required</strong> assignment pointing at the <strong>microsoft.graph.allDevicesAssignmentTarget</strong> object, and <strong>including</strong> our filter as part of the assignment.</p>

<p>If you were to replicate this experience, but use your own security groups, you’d simply change the target <strong>odata.type</strong> to <code class="language-plaintext highlighter-rouge">microsoft.graph.groupAssignmentTarget</code> and add a <strong>groupId</strong> property underneath it, as shown below.</p>

<pre><code class="language-PowerShell">$filterId = '2727f0f4-d030-4792-8aba-b6ef5efe602d' #your filter id
$groupId = 'da630732-10ac-47ae-94f9-2e5b9042109c' #your group id
$assignments = @{
    mobileAppAssignments = @(
        @{
            '@odata.type' = '#microsoft.graph.mobileAppAssignment'
            intent        = 'Required'
            target        = @{
                '@odata.type'                              = '#microsoft.graph.groupAssignmentTarget',
                groupId                                    = $groupId,
                deviceAndAppManagementAssignmentFilterId   = $filterId
                deviceAndAppManagementAssignmentFilterType = 'include'
            }
        }
    )
} | ConvertTo-Json -Depth 10
</code></pre>

<p>Similarly, if you wanted to <strong>exclude</strong> the objects captured in the filter group, change the <strong>deviceAndAppManagementAssignmentFilterType</strong> property to <strong>exclude</strong> - amazing, isn’t it!</p>

<p>Now that we have our request body formed, let’s post it to our policy.</p>

<pre><code class="language-PowerShell">$policyId = '149bf3d2-56cf-4cda-a3ea-79b6adb1c638' #your application policy id
$baseGraphUri = 'https://graph.microsoft.com/beta/deviceAppManagement/mobileApps/{0}/assign' -f $policyId
$graphParams = @{
    Method         = 'Post'
    Uri            = $baseGraphUri
    Authentication = 'OAuth'
    Token          = $authToken.AccessToken | ConvertTo-SecureString -AsPlainText -Force
    ContentType    = 'Application/Json'
    Body           = $assignments
}
Invoke-RestMethod @graphParams
</code></pre>

<p>Post requests to the assign endpoint don’t return anything back to us, but as long as we don’t get any errors, we should be good to go.</p>

<p><a href="/assets/images/2021/07/image2.gif" title="Successful assignment"><img src="/assets/images/2021/07/image2.gif" alt="Successful assignment" /></a></p>

<p>How simple is that!</p>

<p>Now, thanks to filters, you can start scoping policies and applications to larger groups, and use filters to tighten up the scope in a simple reusable fashion.</p>

<p>— Ben</p>

            </article>
        </div>
    </div><div class="main-overlay max-w-5xl mx-auto pb-4 overflow-hidden">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3537558222002149" crossorigin="anonymous"></script>
    <!-- horizontal-ad-unit -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3537558222002149" data-ad-slot="4617860412" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-yellow" />
    </div>
    <h2 class="drac-heading drac-heading-xl drac-text-yellow">Related Posts</h2>
    <ul class="related">
        
        <li><a href="/2021/08/15/authenticate-to-graph-directly-from-powerbi/"><span class="drac-text-yellow">&raquo;</span> Authenticate to Graph directly from PowerBI!</a></li>
        
        <li><a href="/2021/01/19/publishing-powershell-scripts-to-intune-with-graph/"><span class="drac-text-yellow">&raquo;</span> Publishing PowerShell scripts to Intune with Graph</a></li>
        
        <li><a href="/2021/07/18/authenticating-to-microsoft-graph-with-powershell-(2021)/"><span class="drac-text-yellow">&raquo;</span> Authenticating to Microsoft Graph with PowerShell - (2021)</a></li>
        
        <li><a href="/2020/04/21/creating-endpoint-security-policies-with-powershell/"><span class="drac-text-yellow">&raquo;</span> Creating Endpoint Security Policies with PowerShell</a></li>
        
        <li><a href="/2020/03/15/synchronize-sharepoint-sites-with-intune-powershell/"><span class="drac-text-yellow">&raquo;</span> Synchronize SharePoint sites with Intune & PowerShell</a></li>
        
    </ul>
</div>
<div class="pagination main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center utterances">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-hr-bg-yellow" />
    </div>
    <script src="https://utteranc.es/client.js" repo="tabs-not-spaces/powers-hell-blog" issue-term="title" theme="github-dark" crossorigin="anonymous" async>
    </script>
</div></main>
  </div><script src="/assets/js/app.js"></script>
<script src="/assets/js/prism.js"></script>
<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<link rel="stylesheet" href="/assets/css/lightbox.css">
</div>
<div>
    <svg class="wave" viewBox="0 0 1792 95.1" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path
            d="M1792,95.1c0-27,0-54,0-80.9c-40.7-5.1-101.2-11-174.5-12.3c-185.3-3.3-260.9,26.8-411.8,42.6
c-297.5,31.2-285-56-548.1-16.1C536.2,46.6,452.1,77.6,335.5,43C294,30.7,251,10.8,179.2,3C104.9-5,42.2,4.5,0,14.1v80.9H1792z" />
    </svg>
    <footer class="main-overlay drac-bg-blackBlack flex flex-wrap items-center justify-between p-3 m-auto">
        <div class="container mx-auto flex flex-col flex-wrap items-center justify-between">
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p class="drac-text-purple-cyan">
                        Powers Hell © 2021
                    </p>
                </span>
            </div>
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p>
                        made by
                        <a href="https://twitter.com/powers_hell" target="_blank" class="drac-text-yellow">
                            Ben
                        </a>
                        with
                        <a href="https://github.com/tabs-not-spaces/powers-hell-blog" target="_blank"
                            class="drac-text-yellow-pink">
                            code, coffee & beer
                        </a>
                        🍻
                    </p>
                </span>
            </div>
        </div>
    </footer>
</div></body>

</html>